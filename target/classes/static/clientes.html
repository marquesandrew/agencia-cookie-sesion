<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div id="navbar"></div>
    <main class="container py-4">
        <div class="row g-3">
            <div class="col-12 col-lg-4">
                <div class="card">
                    <div class="card-header">Cliente</div>
                    <div class="card-body">
                        <form id="formCliente" class="row g-2">
                            <input type="hidden" id="id">
                            <div class="col-12"><input id="nome" class="form-control" placeholder="Nome" required></div>
                            <div class="col-12"><input id="email" type="email" class="form-control" placeholder="Email"
                                    required></div>
                            <div class="col-6"><input id="telefone" class="form-control" placeholder="Telefone"></div>
                            <div class="col-6"><input id="documento" class="form-control" placeholder="Documento"></div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary" id="btnSalvar">Salvar</button>
                                <button class="btn btn-secondary" type="button" id="btnNovo">Novo</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <span>Lista de Clientes</span>
                        <input id="busca" class="form-control form-control-sm w-auto"
                            placeholder="Buscar por nome/email..." />
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped align-middle mb-0" id="tbl">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Telefone</th>
                                        <th style="width:140px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { bootPage, getJSON, postJSON, putJSON, del } from '/js/app.js';
        await bootPage();

        let lista = [];

        function preencherForm(c = { id: '', nome: '', email: '', telefone: '', documento: '' }) {
            id.value = c.id || '';
            nome.value = c.nome || '';
            email.value = c.email || '';
            telefone.value = c.telefone || '';
            documento.value = c.documento || '';
        }

        async function carregar() {
            lista = await getJSON('/api/clientes');
            render(lista);
        }

        function render(arr) {
            const q = (busca.value || '').toLowerCase();
            const dados = arr.filter(c =>
                (c.nome || '').toLowerCase().includes(q) || (c.email || '').toLowerCase().includes(q));
            const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML = '';
            for (const c of dados) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td>${c.id}</td>
        <td>${c.nome}</td>
        <td>${c.email}</td>
        <td>${c.telefone || ''}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-warning" data-edit="${c.id}">Editar</button>
          <button class="btn btn-sm btn-danger" data-del="${c.id}">Excluir</button>
        </td>`;
                tbody.appendChild(tr);
            }
            tbody.querySelectorAll('button[data-edit]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const item = lista.find(x => x.id == btn.dataset.edit);
                    preencherForm(item);
                });
            });
            tbody.querySelectorAll('button[data-del]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (confirm('Excluir cliente?')) { await del('/api/clientes/' + btn.dataset.del); carregar(); }
                });
            });
        }

        formCliente.addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                nome: nome.value, email: email.value,
                telefone: telefone.value, documento: documento.value
            };
            if (id.value) {
                await putJSON('/api/clientes/' + id.value, body);
            } else {
                await postJSON('/api/clientes', body);
            }
            preencherForm(); carregar();
        });

        btnNovo.addEventListener('click', () => preencherForm());
        busca.addEventListener('input', () => render(lista));

        carregar();
    </script>
</body>

</html>