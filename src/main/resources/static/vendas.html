<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div id="navbar"></div>

    <main class="container py-4">
        <div class="row g-3">
            <div class="col-12 col-xl-5">
                <div class="card">
                    <div class="card-header">Venda</div>
                    <div class="card-body">
                        <form id="formVenda" class="row g-2">
                            <input type="hidden" id="id">
                            <div class="col-12">
                                <label class="form-label">Cliente</label>
                                <select id="selCliente" class="form-select" required></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Vendedor</label>
                                <select id="selVendedor" class="form-select" required></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Pacote</label>
                                <select id="selPacote" class="form-select" required></select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Qtd Pessoas</label>
                                <input id="qtd" type="number" class="form-control" value="1" min="1">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Adicionais</label>
                                <select id="selAdic" class="form-select" multiple size="6"></select>
                                <div class="form-text">Segure Ctrl (ou Cmd) para múltiplos.</div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-success">Salvar</button>
                                <button type="button" class="btn btn-secondary" id="btnNovo">Novo</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Vendas Registradas</span>
                        <input id="busca" class="form-control form-control-sm w-auto"
                            placeholder="Buscar por cliente/pacote..." />
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped align-middle mb-0" id="tbl">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Pacote</th>
                                        <th>Qtd</th>
                                        <th>Total</th>
                                        <th>Data</th>
                                        <th style="width:160px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { bootPage, getJSON, postJSON, putJSON, del } from '/js/app.js';
        await bootPage();

        let cacheVendas = [];

        async function options(url, sel, labelFn) {
            const dados = await getJSON(url);
            sel.innerHTML = '';
            for (const x of dados) {
                const o = document.createElement('option');
                o.value = x.id;
                o.textContent = labelFn(x);
                sel.appendChild(o);
            }
        }

        async function carregarSeletores() {
            await options('/api/clientes', selCliente, c => `${c.nome} (#${c.id})`);
            await options('/api/vendedores', selVendedor, v => `${v.nome}`);
            await options('/api/pacotes', selPacote, p => `${p.titulo} — ${p.precoBase}`);
            await options('/api/adicionais', selAdic, a => `${a.nome} (+${a.preco})`);
        }

        function preencherForm(v = { id: '', cliente: null, vendedor: null, pacote: null, quantidade: 1, adicionais: [] }) {
            id.value = v.id || '';
            qtd.value = v.quantidade || 1;

            if (v.cliente?.id) selCliente.value = String(v.cliente.id);
            else if (selCliente.options.length) selCliente.selectedIndex = 0;

            if (v.vendedor?.id) selVendedor.value = String(v.vendedor.id);
            else if (selVendedor.options.length) selVendedor.selectedIndex = 0;

            if (v.pacote?.id) selPacote.value = String(v.pacote.id);
            else if (selPacote.options.length) selPacote.selectedIndex = 0;

            // múltiplos adicionais
            Array.from(selAdic.options).forEach(o => o.selected = false);
            (v.adicionais || []).forEach(a => {
                const opt = Array.from(selAdic.options).find(o => Number(o.value) === a.id);
                if (opt) opt.selected = true;
            });
        }

        async function listarVendas() {
            cacheVendas = await getJSON('/api/vendas');
            render(cacheVendas);
        }

        function render(arr) {
            const q = (busca.value || '').toLowerCase();
            const dados = arr.filter(v =>
                (v.cliente?.nome || '').toLowerCase().includes(q) ||
                (v.pacote?.titulo || '').toLowerCase().includes(q)
            );

            const tb = document.querySelector('#tbl tbody'); tb.innerHTML = '';
            for (const v of dados) {
                const data = v.dataVenda ? new Date(v.dataVenda).toLocaleString() : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td>${v.id}</td>
        <td>${v.cliente?.nome || ''}</td>
        <td>${v.pacote?.titulo || ''}</td>
        <td>${v.quantidade}</td>
        <td>${v.valorTotal}</td>
        <td>${data}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-warning" data-edit="${v.id}">Editar</button>
          <button class="btn btn-sm btn-danger" data-del="${v.id}">Excluir</button>
        </td>`;
                tb.appendChild(tr);
            }

            // editar
            tb.querySelectorAll('button[data-edit]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const venda = cacheVendas.find(x => x.id == btn.dataset.edit);
                    preencherForm(venda);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });

            // excluir
            tb.querySelectorAll('button[data-del]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (confirm('Excluir venda?')) {
                        await del('/api/vendas/' + btn.dataset.del);
                        listarVendas();
                    }
                });
            });
        }

        formVenda.addEventListener('submit', async e => {
            e.preventDefault();
            const adicionais = Array.from(selAdic.selectedOptions).map(o => ({ id: Number(o.value) }));
            const body = {
                cliente: { id: Number(selCliente.value) },
                vendedor: { id: Number(selVendedor.value) },
                pacote: { id: Number(selPacote.value) },
                quantidade: Number(qtd.value || 1),
                adicionais
            };

            if (id.value) {
                await putJSON('/api/vendas/' + id.value, body);
            } else {
                await postJSON('/api/vendas', body);
            }
            preencherForm(); // limpa
            listarVendas();
        });

        btnNovo.addEventListener('click', () => preencherForm());
        busca.addEventListener('input', () => render(cacheVendas));

        await carregarSeletores();
        await listarVendas();
    </script>
</body>

</html>